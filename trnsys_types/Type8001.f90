      Subroutine Type8001

! Object: Equipment Availability by probability state matrix
! Simulation Studio Model: Type8001
! 

! Author: Howard Cheung and Shengwei Wang
! Editor: 
! Date:	 April 25, 2018
! last modified: April 25, 2018
! 
! It uses dynamic storage to store the state of the machine and the time of the machine
! in the previous time step to judge if the machine should be available for control in the
! current time step. Since the calculation is based on the operation time of a machine
! when it is normal, it also expects an delayed input of control on/off of the machine
! from Type150 too.
! 
! At start time:
! Step 1: Creates two dynamic storages - 1 for state and 1 for time at a state
! Step 2: Set the initial state with the variable InitialState and initial time
! at a state to be zero.
! 
! At other times:
! Step 1: Get the control on/off signal from the previous time step
! Step 2: Get the dynamic storage
! Step 3: Update the operation time when it is normal
! Step 3: Calculate the probability matrix of state transition
! Step 4: Get a random number from a pseudorandom number generator
! Step 5: Judge the next state
! Step 6: Update the state variable
! Step 7: Update the state time by the operation time if it is normal
! Step 8: Update the state time by incrementing it if it has failed
! Step 9: Outputs
! *** 
! *** Model Parameters 
! *** 
!			MTTF	hr [0;+Inf]
!			MTTR	hr [0;+Inf]
!			InitialState	- [0;1]

! *** 
! *** Model Inputs 
! *** 
!			DelayedOnOff	- [0;1]
!			RandomNumber	- [0;1]

! *** 
! *** Model Outputs 
! *** 
!			CurrentState	- [0;1]
!			CurrentStateTime	hr [0;+Inf]
!			ProbUnchanged	- [0;+Inf]
!			PreviousState	- [0;1]
!			PreviousTime	- [0;+Inf]

! *** 
! *** Model Derivatives 
! *** 

! (Comments and routine interface generated by TRNSYS Simulation Studio)
!************************************************************************

!-----------------------------------------------------------------------------------------------------------------------
! This TRNSYS component skeleton was generated from the TRNSYS studio based on the user-supplied parameters, inputs, 
! outputs, and derivatives.  The user should check the component formulation carefully and add the content to transform
! the parameters, inputs and derivatives into outputs.  Remember, outputs should be the average value over the timestep
! and not the value at the end of the timestep; although in many models these are exactly the same values.  Refer to 
! existing types for examples of using advanced features inside the model (Formats, Labels etc.)
!-----------------------------------------------------------------------------------------------------------------------


      Use TrnsysConstants
      Use TrnsysFunctions

!-----------------------------------------------------------------------------------------------------------------------

!DEC$Attributes DLLexport :: Type8001

!-----------------------------------------------------------------------------------------------------------------------
!Trnsys Declarations
      Implicit None

      Double Precision Timestep,Time
      Integer CurrentUnit,CurrentType


!    PARAMETERS
      DOUBLE PRECISION MTTF
      DOUBLE PRECISION MTTR
      DOUBLE PRECISION InitialState

!    INPUTS
      DOUBLE PRECISION DelayedOnOff
      DOUBLE PRECISION RandomNumber

!    INTERNAL VARIABLE
      Integer PreviousState               !Last state
      DOUBLE PRECISION PreviousTime       !Previous operation/Current maintenance time
      Integer CurrentState                !State calculated 
      DOUBLE PRECISION CurrentTime        !Current operation/Future maintenance time
      DOUBLE PRECISION ProbUnchanged      !Probaility to remain in the current state

!-----------------------------------------------------------------------------------------------------------------------

!-----------------------------------------------------------------------------------------------------------------------
!Get the Global Trnsys Simulation Variables
      Time=getSimulationTime()
      Timestep=getSimulationTimeStep()
      CurrentUnit = getCurrentUnit()
      CurrentType = getCurrentType()
!-----------------------------------------------------------------------------------------------------------------------

!-----------------------------------------------------------------------------------------------------------------------
!Set the Version Number for This Type
      If(getIsVersionSigningTime()) Then
		Call SetTypeVersion(17)
		Return
      EndIf
!-----------------------------------------------------------------------------------------------------------------------

!-----------------------------------------------------------------------------------------------------------------------
!Do Any Last Call Manipulations Here
      If(getIsLastCallofSimulation()) Then
		Return
      EndIf
!-----------------------------------------------------------------------------------------------------------------------

!-----------------------------------------------------------------------------------------------------------------------
!Perform Any "After Convergence" Manipulations That May Be Required at the End of Each Timestep
      If(getIsEndOfTimestep()) Then
		Return
      EndIf
!-----------------------------------------------------------------------------------------------------------------------

!-----------------------------------------------------------------------------------------------------------------------
!Do All of the "Very First Call of the Simulation Manipulations" Here
      If(getIsFirstCallofSimulation()) Then

		!Tell the TRNSYS Engine How This Type Works
		Call SetNumberofParameters(3)           !The number of parameters that the the model wants
		Call SetNumberofInputs(2)                   !The number of inputs that the the model wants
		Call SetNumberofDerivatives(0)         !The number of derivatives that the the model wants
		Call SetNumberofOutputs(5)                 !The number of outputs that the the model produces
		Call SetIterationMode(1)                             !An indicator for the iteration mode (default=1).  Refer to section 8.4.3.5 of the documentation for more details.
		Call SetNumberStoredVariables(0,2)                   !The number of static variables that the model wants stored in the global storage array and the number of dynamic variables that the model wants stored in the global storage array
		Call SetNumberofDiscreteControls(0)               !The number of discrete control functions set by this model (a value greater than zero requires the user to use Solver 1: Powell's method)

		Return

      EndIf
!-----------------------------------------------------------------------------------------------------------------------

!-----------------------------------------------------------------------------------------------------------------------
!Do All of the First Timestep Manipulations Here - There Are No Iterations at the Intial Time
      If (getIsStartTime()) Then
      MTTF = getParameterValue(1)
      MTTR = getParameterValue(2)
      InitialState = getParameterValue(3)


      DelayedOnOff = GetInputValue(1)
      RandomNumber = GetInputValue(2)

	
   !Check the Parameters for Problems (#,ErrorType,Text)
   !Sample Code: If( PAR1 <= 0.) Call FoundBadParameter(1,'Fatal','The first parameter provided to this model is not acceptable.')

   !Set the Initial Values of the Outputs (#,Value)
		Call SetOutputValue(1, 1) ! CurrentState
		Call SetOutputValue(2, 0) ! CurrentStateTime
		Call SetOutputValue(3, 0) ! ProbUnchanged
		Call SetOutputValue(4, 0) ! PreviousState
		Call SetOutputValue(5, 0) ! PreviousTime


   !If Needed, Set the Initial Values of the Static Storage Variables (#,Value)
   !Sample Code: SetStaticArrayValue(1,0.d0)

   !If Needed, Set the Initial Values of the Dynamic Storage Variables (#,Value)
   !Sample Code: Call SetDynamicArrayValueThisIteration(1,20.d0)
   
      !Set the values of dynamic storages
        Call setDynamicArrayInitialValue(1,InitialState)
        Call setDynamicArrayInitialValue(2,0.0)

   !If Needed, Set the Initial Values of the Discrete Controllers (#,Value)
   !Sample Code for Controller 1 Set to Off: Call SetDesiredDiscreteControlState(1,0) 

		Return

      EndIf
!-----------------------------------------------------------------------------------------------------------------------

!-----------------------------------------------------------------------------------------------------------------------
!ReRead the Parameters if Another Unit of This Type Has Been Called Last
      If(getIsReReadParameters()) Then
		!Read in the Values of the Parameters from the Input File
      MTTF = getParameterValue(1)
      MTTR = getParameterValue(2)
      InitialState = getParameterValue(3)

		
      EndIf
!-----------------------------------------------------------------------------------------------------------------------

!Read the Inputs
      DelayedOnOff = GetInputValue(1)
      RandomNumber = GetInputValue(2)
		

	!Check the Inputs for Problems (#,ErrorType,Text)
	!Sample Code: If( IN1 <= 0.) Call FoundBadInput(1,'Fatal','The first input provided to this model is not acceptable.')
 
      If(ErrorFound()) Return
!-----------------------------------------------------------------------------------------------------------------------

!-----------------------------------------------------------------------------------------------------------------------
!    *** PERFORM ALL THE CALCULATION HERE FOR THIS MODEL. ***
!-----------------------------------------------------------------------------------------------------------------------

	!-----------------------------------------------------------------------------------------------------------------------
	!If Needed, Get the Previous Control States if Discrete Controllers are Being Used (#)
	!Sample Code: CONTROL_LAST=getPreviousControlState(1)
	!-----------------------------------------------------------------------------------------------------------------------

	!-----------------------------------------------------------------------------------------------------------------------
	!If Needed, Get the Values from the Global Storage Array for the Static Variables (#)
	!Sample Code: STATIC1=getStaticArrayValue(1)
	!-----------------------------------------------------------------------------------------------------------------------

	!-----------------------------------------------------------------------------------------------------------------------
	!If Needed, Get the Initial Values of the Dynamic Variables from the Global Storage Array (#)
	!Sample Code: T_INITIAL_1=getDynamicArrayValueLastTimestep(1)
	!-----------------------------------------------------------------------------------------------------------------------
      PreviousState = getDynamicArrayValueLastTimestep(1)
      PreviousTime = getDynamicArrayValueLastTimestep(2)

	!-----------------------------------------------------------------------------------------------------------------------
	!Perform All of the Calculations Here to Set the Outputs from the Model Based on the Inputs
    
      !Update the operation time when it is normal
      If ((DelayedOnOff.EQ.1).AND.(PreviousState.EQ.1)) Then
        PreviousTime = PreviousTime + Timestep  !Now it is the current operation time
      EndIf

      !Calculate if the state is changed
      ProbUnchanged = 1.0
      CurrentState = PreviousState
      CurrentTime = PreviousTime
      If (PreviousState.EQ.1) Then
        ProbUnchanged = EXP(-(PreviousTime/MTTF))
        If (RandomNumber.GT.ProbUnchanged) Then
          CurrentState = 0
          CurrentTime = Timestep  !Intial maintenance time
        Else
          CurrentState = 1
          CurrentTime = PreviousTime
        EndIf
      Else
        ProbUnchanged = EXP(-(PreviousTime/MTTR))
        If (RandomNumber.GT.ProbUnchanged) Then
          CurrentState = 1
          CurrentTime = 0.0  !Operation time to be updated in the next iteration
        Else
          CurrentState = 0
          CurrentTime = PreviousTime + Timestep
        EndIf
      EndIf

!-----------------------------------------------------------------------------------------------------------------------

!-----------------------------------------------------------------------------------------------------------------------
!Set the Outputs from this Model (#,Value)
		Call SetOutputValue(1, CurrentState) ! CurrentState
		Call SetOutputValue(2, CurrentTime) ! CurrentStateTime
		Call SetOutputValue(3, ProbUnchanged) ! ProbUnchanged
		Call SetOutputValue(4, PreviousState) ! PreviousState
		Call SetOutputValue(5, PreviousTime) ! CurrentTime

!-----------------------------------------------------------------------------------------------------------------------

!-----------------------------------------------------------------------------------------------------------------------
!If Needed, Store the Desired Disceret Control Signal Values for this Iteration (#,State)
!Sample Code:  Call SetDesiredDiscreteControlState(1,1)
!-----------------------------------------------------------------------------------------------------------------------

!-----------------------------------------------------------------------------------------------------------------------
!If Needed, Store the Final value of the Dynamic Variables in the Global Storage Array (#,Value)
!Sample Code:  Call SetDynamicArrayValueThisIteration(1,T_FINAL_1)
!-----------------------------------------------------------------------------------------------------------------------
 
      Call setDynamicArrayValueThisIteration(1, CurrentState)
      Call setDynamicArrayValueThisIteration(2, CurrentTime)
  
      Return
      End
!-----------------------------------------------------------------------------------------------------------------------

